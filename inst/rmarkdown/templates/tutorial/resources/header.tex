\usepackage[framemethod=TikZ]{mdframed}
\usepackage{xcolor}

\usepackage{fancyvrb} % Fancy Verbatim: Used for the R code output
\usepackage{caption}  % We will not place figures in floats: required if captions are needed

\makeatletter
\@ifclassloaded{exam}
  {
    % Nothing to do: altering headers will collapse with the exam class
  }{
    \usepackage{fancyhdr}
    \let\runauthor\@author
    \let\runtitle\@title
    \global\let\tikz@ensure@dollar@catcode=\relax
    \pagestyle{fancy}
    \lhead{\runauthor}
    \rhead{\runtitle}
  }%
\makeatother

\definecolor{celadon}{rgb}{0.67, 0.88, 0.69} % Define a nice green color for the correction

% Used to format the R code when setting "only_asis" to FALSE (uses knitr:::hilight_source)
\makeatletter
\newcommand{\hlnum}[1]{\textcolor[rgb]{0.686,0.059,0.569}{#1}}
\newcommand{\hlstr}[1]{\textcolor[rgb]{0.192,0.494,0.8}{#1}}
\newcommand{\hlcom}[1]{\textcolor[rgb]{0.678,0.584,0.686}{\textit{#1}}}
\newcommand{\hlopt}[1]{\textcolor[rgb]{0,0,0}{#1}}
\newcommand{\hlstd}[1]{\textcolor[rgb]{0.345,0.345,0.345}{#1}}
\newcommand{\hlkwa}[1]{\textcolor[rgb]{0.161,0.373,0.58}{\textbf{#1}}}
\newcommand{\hlkwb}[1]{\textcolor[rgb]{0.69,0.353,0.396}{#1}}
\newcommand{\hlkwc}[1]{\textcolor[rgb]{0.333,0.667,0.333}{#1}}
\newcommand{\hlkwd}[1]{\textcolor[rgb]{0.737,0.353,0.396}{\textbf{#1}}}
\makeatother


% Disabling as it may cause an option clash
% http://tex.stackexchange.com/questions/8422/how-to-include-graphics-with-spaces-in-their-path
% Necessary to compile the tex file with white spaces in graphic files
%\usepackage{graphicx}
%\usepackage[space]{grffile}


% Defining the base style of the box as bbox
\mdfdefinestyle{bbox}{
	leftmargin = 0cm,%
	rightmargin = 0cm,%
	innerleftmargin = 0.5cm,%
	innerrightmargin = 0.5cm,%
	roundcorner = 5pt,%
	linewidth = 2pt,%
	nobreak=false%,
	%needspace=1in % Trying to avoid a page break after the title but does not do the trick...
	}

% Defining custom box environment (cbox) with 2 arguments:
% The first optional (defaults to empty string) is the title of the box
% The second (mandatory) defines the color of the box (linecolor and background is linecolor!30)
\newenvironment{cbox}[2][]{
\def\temp{#1}\ifx\temp\empty
	\begin{mdframed}[style=bbox,%
		linecolor = #2,%
		%innertopmargin = 0.3pt,
		backgroundcolor = #2!30]%
\else
	\begin{mdframed}[style=bbox,%
		linecolor = #2,%
		backgroundcolor = #2!30,%
		innertopmargin=3pt,%
		frametitle={\tikz[baseline = (current bounding box.east), outer sep = 0pt]
		\node[anchor = east, rounded corners = 3pt, rectangle, fill = #2]{#1};},%
		frametitleaboveskip = \dimexpr-\ht\strutbox\relax]
\fi

}{\end{mdframed}}

\mdfdefinestyle{input}{
	frametitle = {},%
  leftmargin = 0cm,%
  rightmargin = 0cm,%
  innerleftmargin = 0.2cm,%
  innerrightmargin = 0.2cm,%
  roundcorner = 2pt,%
	linecolor = lightgray,%
	linewidth = 1pt,%
	backgroundcolor = lightgray!30
	}

\newcommand{\cboxs}[2][]{\begin{cbox}[#1]{#2}}
\newcommand{\cboxe}{\end{cbox}}
\newcommand{\solutions}{\begin{cbox}[Solution]{celadon}}
\newcommand{\solutione}{\end{cbox}}
% Defining the solution environment to draw a green block around its content
% \newenvironment{solution}{\begin{cbox}[Solution]{celadon}}{\end{cbox}}


\makeatletter

% Collection of macros calling the MCQ environments from
%  the exam class instead of the itemize environment

% Backing up item and the itemize environment.
\let\origitem\item
\let\origitemize\itemize
\let\origenditemize\enditemize

% Macro to restore the original itemize environment
\newcommand{\restoreitemize}{
	\let\itemize\origitemize
	\let\enditemize\origenditemize
	\let\item\origitem
}

\newcommand{\opc}[1]{
	\ifstrequal{#1}{on}{
		\let\itemize\oneparchoices
		\let\enditemize\endoneparchoices
		\def\item{\choice}
	}{\restoreitemize}
}

\newcommand{\opcb}[1]{
	\ifstrequal{#1}{on}{
		\let\itemize\oneparcheckboxes
		\let\enditemize\endoneparcheckboxes
		\def\item{\choice}
	}{\restoreitemize}
}

\newcommand{\cb}[1]{
	\ifstrequal{#1}{on}{
		\let\itemize\checkboxes
		\let\enditemize\endcheckboxes
		\def\item{\choice}
	}{\restoreitemize}
}

\newcommand{\ch}[1]{
	\ifstrequal{#1}{on}{
		\let\itemize\choices
		\let\enditemize\endchoices
		\def\item{\choice}
	}{\restoreitemize}
}
\makeatother

% Alternative oneparchoices and oneparcheckboxes
% with equally spaced horizontal items.
% The number of items per line can be adjusted (defaults to 3)
%
% Taken and adapted from the following stackexchange post:
% http://tex.stackexchange.com/questions/149101/inline-arrangement-using-enumitem

\usepackage{environ, multido, calc}% http://ctan.org/pkg/{environ,multido,calc}
\makeatletter
% Taken from http://tex.stackexchange.com/a/128318/5764
\newcounter{listcount}% Keep track of \item
\newcounter{q}% Enumerate the different items

\NewEnviron{oneparchoicesalt}[1][\perline]{%
  \setcounter{listcount}{0}% Start with 0 \items
  \g@addto@macro{\BODY}{\item\relax\item}% Used to delimit the items; last item identified by \item\relax\item
  \def\item##1\item{% Redefine \item to capture contents
    \def\optarg{##1}%
    \expandafter\ifx\optarg\relax\else% Last item not reached
      \stepcounter{listcount}% Next item being processed
      \expandafter\gdef\csname inlineitem@\thelistcount\endcsname{##1}% Store item in control sequence
      \expandafter\item% Recursively continue processing items
    \fi
  }%
  \BODY% Process environment (save items)
  \setlength{\@tempdima}{\linewidth/#1}% Set length of each \item \parbox; possibly corrent...
  \ifnum\value{listcount}<#1\relax\setlength{\@tempdima}{\linewidth/\value{listcount}}\fi%... if needed
  \par\noindent% Start new non-indented paragraph
  \multido{\i=1+1}{\value{listcount}}{% Insert all items in a \parbox
    \parbox[t]{\@tempdima}{\raggedright\hangindent=1.5em\hangafter=1% Paragraph formatting
      \makebox[1.5em][r]{ \setcounter{q}{\i}
\opccounter\space}\strut\csname inlineitem@\i\endcsname\strut}\hspace{0pt}}%
}


\newcommand{\perline}{3}
\newcommand{\opccounter}{\Alph{q})}
\newcommand{\opcalt}[2][3]{
	% Passing variables with the help of macros
	% and not arguments to homogenize the call.
	\renewcommand{\perline}{#1}
	\renewcommand{\opccounter}{\Alph{q})}
  \ifstrequal{#2}{on}{
    % Switching itemize to MCQ mode
    \let\itemize\oneparchoicesalt
    \let\enditemize\endoneparchoicesalt
	}{\restoreitemize}
}

\newcommand{\opcbalt}[2][3]{
	% Passing variables with the help of macros
	% and not arguments to homogenize the call.
	\renewcommand{\perline}{#1}
	\renewcommand{\opccounter}{\checkbox@char}
  \ifstrequal{#2}{on}{
    % Switching itemize to MCQ mode
    \let\itemize\oneparchoicesalt
    \let\enditemize\endoneparchoicesalt
	}{\restoreitemize}
}

\makeatother
